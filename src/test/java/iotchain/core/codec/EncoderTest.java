package iotchain.core.codec;

import iotchain.core.crypto.Hash;
import iotchain.core.model.BlockHeader;
import iotchain.core.model.SignedTransaction;
import org.junit.Test;
import org.web3j.abi.datatypes.Address;
import org.web3j.abi.datatypes.generated.Uint256;
import org.web3j.utils.Numeric;

import java.math.BigInteger;
import java.util.Arrays;
import java.util.Collections;

import static org.hamcrest.CoreMatchers.is;
import static org.junit.Assert.assertThat;

public class EncoderTest {
    @Test
    public void testTransactionEncode(){
        SignedTransaction tx = new SignedTransaction(
                BigInteger.ONE,
                BigInteger.valueOf(1),
                BigInteger.valueOf(20000),
                "e3b6f948139e86a36d2421eb01b43eec72006e6a",
                BigInteger.valueOf(100000),
                "a9059cbb0000000000000000000000001f68569be9660aecf345fe6f47940f21fee272800000000000000000000000000000000000000000000000008ac7230489e80000",
                BigInteger.valueOf(47),
                new BigInteger("87943571959770171205439940493381448938079608149992805174612893211086812822243"),
                new BigInteger("19063619772539772086135068106034353823731945615802570915163832710298780911179")
        );

        byte[] rlp = Encoder.encode(tx);
        assertThat(Numeric.toHexString(rlp),
                is("0xf8a70101824e2094e3b6f948139e86a36d2421eb01b43eec72006e6a830186a0b844a9059cbb0000000000000000000000001f68569be9660aecf345fe6f47940f21fee272800000000000000000000000000000000000000000000000008ac7230489e800002fa0c26e4c3c441978404276c0d53b2e606fc3b25db417c3238cba795fff43bb3ae3a02a25a05d258eb27c595ef5730aa2873280bf2260fedd7a47cbd861fa2c31464b"));
    }

    @Test
    public void testBlockEncode(){
        BlockHeader header = new BlockHeader(
                "62e53cf4b0364630c05bb70eedeae7f8c4917e5fd324accd9b171b8867a1f695",
                "fba6ebcb8a45cec3019e1dcd39ad74353b64935a",
                "2dc565eb7fb29bf2f49d25f208fcbdb5bf8006cc90e1e352b09f559c9cdd1e8a",
                "56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421",
                "56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421",
                "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                BigInteger.valueOf(11),
                BigInteger.valueOf(545395),
                BigInteger.valueOf(16716680),
                BigInteger.valueOf(0),
                1571216350000L,
                "0xf849c0f843a0cd8cb62270e070cfafac1e7e76f35785fdbae3e4d263a7b8dd008120fa697056a017e9eeeaff40fe6ebf0e4be092f98bbae4f8529376fbae66e88f9436ff51ea0b308200c0"
        );

        byte[] rlp = Encoder.encode(header);
        assertThat(Numeric.toHexString(rlp),
                is("0xf901f8a062e53cf4b0364630c05bb70eedeae7f8c4917e5fd324accd9b171b8867a1f69594fba6ebcb8a45cec3019e1dcd39ad74353b64935aa02dc565eb7fb29bf2f49d25f208fcbdb5bf8006cc90e1e352b09f559c9cdd1e8aa056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421b90100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b8308527383ff13888086016dd3cadb30f849c0f843a0cd8cb62270e070cfafac1e7e76f35785fdbae3e4d263a7b8dd008120fa697056a017e9eeeaff40fe6ebf0e4be092f98bbae4f8529376fbae66e88f9436ff51ea0b308200c0"));
    }

    @Test
    public void testFunctionEncode(){
        String encode = Encoder.encodeFunction(
                "transfer",
                Arrays.asList(new Address("0xcecede5A20645EAc6ca2032eeEb1063572D63c29"), new Uint256(new BigInteger("80000000000000000000"))),
                Collections.emptyList());
        assertThat(encode, is("0xa9059cbb000000000000000000000000cecede5a20645eac6ca2032eeeb1063572d63c29000000000000000000000000000000000000000000000004563918244f400000"));
    }
}
